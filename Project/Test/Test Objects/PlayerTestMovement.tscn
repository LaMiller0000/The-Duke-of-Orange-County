[gd_scene load_steps=6 format=3 uid="uid://b6bu7uoeohwdj"]

[ext_resource type="Script" uid="uid://y21p2rpis0rp" path="res://Scripts/TestSpringArm.gd" id="1"]

[sub_resource type="GDScript" id="3"]
script/source = "extends CharacterBody3D

@onready var _spring_arm: SpringArm3D = $SpringArm3D
@onready var eyes: Node3D = $Eyes
var stamina = 100
var activeSpeed = 0
var gravity = 9.8
var target = null
@export var speed = [10, 20]
var _velocity := Vector3.ZERO
var _snap_vector := Vector3.DOWN
enum state {TARGETING, FREECAM}
@export var STATED = state.FREECAM

func _physics_process(_delta: float) -> void:
	if Input.is_action_pressed(\"ui_accept\") && stamina > 0:
		activeSpeed = 1
	else:
		activeSpeed = 0
	match STATED:
		state.FREECAM:
			_velocity.x = Input.get_action_strength(\"right\") - Input.get_action_strength(\"left\")
			_velocity.z = Input.get_action_strength(\"down\") - Input.get_action_strength(\"forward\")
			_velocity = _velocity.rotated(Vector3.UP, _spring_arm.rotation.y).normalized()
		state.TARGETING:
			_velocity.z = Input.get_action_strength(\"forward\") - Input.get_action_strength(\"down\")
			_velocity.x = Input.get_action_strength(\"left\") - Input.get_action_strength(\"right\")
			eyes.look_at(target.global_transform.origin, Vector3.DOWN)
			_velocity = _velocity.rotated(Vector3.UP, eyes.rotation.y).normalized()
		_:
			print(\"NOTHING\")
	_velocity.y -= gravity * _delta
	set_velocity(_velocity.normalized() * speed[activeSpeed])
	# TODOConverter3To4 looks that snap in Godot 4 is float, not vector like in Godot 3 - previous value `_snap_vector`
	set_up_direction(Vector3.ZERO)
	move_and_slide()
	_velocity = velocity
	_spring_arm.position = position
"

[sub_resource type="CapsuleShape3D" id="1"]

[sub_resource type="CapsuleMesh" id="2"]

[sub_resource type="SeparationRayShape3D" id="4"]

[node name="Root" type="Node3D"]
transform = Transform3D(1.7, 0, 0, 0, 1.7, 0, 0, 0, 1.7, 0, 0, 0)

[node name="PlayerMovementBody" type="CharacterBody3D" parent="."]
script = SubResource("3")

[node name="CollisionShape3D" type="CollisionShape3D" parent="PlayerMovementBody"]
shape = SubResource("1")

[node name="CSGMesh3D" type="CSGMesh3D" parent="PlayerMovementBody/CollisionShape3D"]
mesh = SubResource("2")

[node name="SpringArm3D" type="SpringArm3D" parent="PlayerMovementBody"]
transform = Transform3D(1, 0, 0, 0, 0.866026, 0.5, 0, -0.5, 0.866026, 0, 0, 5)
shape = SubResource("4")
spring_length = 12.0
margin = 0.5
script = ExtResource("1")

[node name="Camera3D" type="Camera3D" parent="PlayerMovementBody/SpringArm3D"]
current = true
fov = 90.0

[node name="Eyes" type="Node3D" parent="PlayerMovementBody"]
